#!/usr/bin/env ruby

# The javascript driver does not use protocol buffers any more, but it uses the constants from the proto file.
# This script strips protobuf-related declarations and wraps the file in the RethinkDB module
# It expects the protobuff definition file to be fed in via stdin, and writes the result out on stdout. 
# Typical usage: `cat ./convert-protofile < ../../src/rdb_protocol/ql2.proto` > OUTPUT_FILE

puts "// DO NOT EDIT"
puts "// Autogenerated by " + File.basename(__FILE__)
puts ""
print "module.exports = {"
indentLevel = 1
lastIndentLevel = 0
ARGF.each do |line|
	if (line =~ /^\s*message (\w+) {/ || line =~ /^\s+enum (\w+) {/)
		print (indentLevel == lastIndentLevel ? ",\n" : "\n") + "\t" * indentLevel + "#{$1}: {"
		lastIndentLevel = indentLevel
		indentLevel += 1
	elsif line =~ /^\s+(\w+)\s+=\s+(\w+);/
		key = $1
		value = $2
		value = value.to_i(base=16) if value =~ /^0x/
		print (indentLevel == lastIndentLevel ? ",\n" : "\n") + "\t" * indentLevel + "#{key}: #{value}"
		lastIndentLevel = indentLevel
	elsif line =~ /^\s*}/
		print (indentLevel == lastIndentLevel ? "\n" + "\t" * (indentLevel - 1) + "}" : "}")
		indentLevel -= 1
		lastIndentLevel = indentLevel
	end
end
puts "\n}"
